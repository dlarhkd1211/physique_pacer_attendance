<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜ì´ì„œ ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        input, select, button {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); color: #212529; }
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
            margin-top: 20px;
        }
        
        .table-wrapper {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        
        /* ê³ ì • ì¹¼ëŸ¼ (ì§ì±…, ì„±ëª…, í•©ê³„) */
        .fixed-columns {
            position: sticky;
            left: 0;
            z-index: 10;
            background: white;
            border-right: 3px solid #667eea;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .fixed-columns table {
            border-collapse: collapse;
            background: white;
            table-layout: fixed;
            width: 240px;
        }
        
        .fixed-columns th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
        }
        
        .fixed-columns th:nth-child(1) { width: 80px; }
        .fixed-columns th:nth-child(2) { width: 100px; }
        .fixed-columns th:nth-child(3) { width: 60px; }
        
        .fixed-columns td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            background: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì¹¼ëŸ¼ ì˜ì—­ */
        .scrollable-columns {
            flex: 1;
            overflow-x: auto;
            min-width: 0;
        }
        
        .scrollable-columns table {
            border-collapse: collapse;
            width: auto;
            min-width: 100%;
        }
        
        .scrollable-columns th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            min-width: 60px;
            white-space: nowrap;
        }
        
        .scrollable-columns td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            min-width: 60px;
        }
        
        .attendance-cell {
            cursor: pointer;
            font-weight: 600;
            border-radius: 4px;
            padding: 8px;
            min-width: 40px;
            min-height: 40px;
            transition: all 0.2s ease;
        }
        
        .attendance-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .present {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }
        
        .absent {
            background: white;
            color: #333;
            border: 2px solid #dee2e6;
        }
        
        .pass { background-color: #e8f5e8; color: #2e7d32; }
        .fail { background-color: #ffebee; color: #c62828; }
        
        /* ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ì•ˆë‚´ */
        .mobile-scroll-hint {
            display: none;
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            padding: 8px;
            background: #fff3cd;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
        }
        
        /* ë©¤ë²„ ê´€ë¦¬ */
        .member-management {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .member-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            position: relative;
        }
        
        .member-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 40px;
        }
        
        .member-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            min-width: 100px;
        }
        
        .member-role {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .member-actions {
            display: flex;
            gap: 10px;
        }
        
        .member-actions button {
            padding: 6px 10px;
            font-size: 12px;
        }
        
        .drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: move;
            color: #6c757d;
            font-size: 16px;
        }
        
        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .close {
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover { color: #000; }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        /* ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { padding: 20px 15px; }
            .header h1 { font-size: 1.8em; }
            .content { padding: 15px; }
            .section { padding: 15px; margin-bottom: 20px; }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            input, select, button {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }
            
            .member-card {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .member-info {
                margin-left: 0;
                flex-direction: column;
                gap: 10px;
            }
            
            .member-actions {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .drag-handle {
                position: static;
                transform: none;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š í˜ì´ì„œ ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p>í”¼ì§€í¬ í˜ì´ì„œ ì¶œì„ ê´€ë¦¬ì í˜ì´ì§€</p>
        </div>
        
        <div class="content">
            <!-- ì›” ì„ íƒ -->
            <div class="section">
                <h2>ğŸ“… ì›” ì„ íƒ</h2>
                <div class="controls">
                    <label>ë…„ë„:</label>
                    <input type="number" id="year" value="2024" min="2020" max="2030">
                    <label>ì›”:</label>
                    <select id="month">
                        <option value="1">1ì›”</option>
                        <option value="2">2ì›”</option>
                        <option value="3">3ì›”</option>
                        <option value="4">4ì›”</option>
                        <option value="5">5ì›”</option>
                        <option value="6" selected>6ì›”</option>
                        <option value="7">7ì›”</option>
                        <option value="8">8ì›”</option>
                        <option value="9">9ì›”</option>
                        <option value="10">10ì›”</option>
                        <option value="11">11ì›”</option>
                        <option value="12">12ì›”</option>
                    </select>
                    <button onclick="loadCurrentMonth()">ì¡°íšŒ</button>
                    <button class="btn-success" onclick="copyFromPreviousMonth()">ì „ì›” ë³µì‚¬</button>
                </div>
                <div id="monthMessage"></div>
            </div>
            
            <!-- ë©¤ë²„ ì¶”ê°€ -->
            <div class="section">
                <h2>ğŸ‘¥ ë©¤ë²„ ì¶”ê°€</h2>
                <div class="controls">
                    <input type="text" id="memberName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <select id="memberRole">
                        <option value="ìš´ì˜ì§„">ìš´ì˜ì§„</option>
                        <option value="í˜ì´ì„œ">í˜ì´ì„œ</option>
                        <option value="í˜ì´ì„œ ê°•ë‚¨">í˜ì´ì„œ ê°•ë‚¨</option>
                        <option value="í¬í† ">í¬í† </option>
                    </select>
                    <button onclick="addMember()">ë©¤ë²„ ì¶”ê°€</button>
                </div>
                <div id="memberMessage"></div>
            </div>
            
            <!-- ë°ì´í„° ë‚´ë³´ë‚´ê¸° -->
            <div class="section">
                <h2>ğŸ“ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h2>
                <div class="controls">
                    <button class="btn-info" onclick="exportToExcel()">ğŸ“Š Excel</button>
                    <button class="btn-info" onclick="exportToCSV()">ğŸ“‹ CSV</button>
                </div>
                <div id="exportMessage"></div>
            </div>
            
            <!-- ì¶œì„ í˜„í™© -->
            <div class="section">
                <h2>ğŸ“Š ì¶œì„ í˜„í™©</h2>
                <div id="attendanceTable">
                    <div class="loading">ì¶œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                </div>
            </div>
            
            <!-- ë©¤ë²„ ê´€ë¦¬ -->
            <div class="section">
                <h2>ğŸ‘¤ ë©¤ë²„ ê´€ë¦¬</h2>
                <div id="memberManagement">
                    <div class="loading">ë©¤ë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì—­í•  ë³€ê²½ ëª¨ë‹¬ -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ì—­í•  ë³€ê²½</h3>
                <span class="close" onclick="closeRoleModal()">&times;</span>
            </div>
            <div>
                <p id="roleModalMemberName"></p>
                <select id="newRole">
                    <option value="ìš´ì˜ì§„">ìš´ì˜ì§„</option>
                    <option value="í˜ì´ì„œ">í˜ì´ì„œ</option>
                    <option value="í˜ì´ì„œ ê°•ë‚¨">í˜ì´ì„œ ê°•ë‚¨</option>
                    <option value="í¬í† ">í¬í† </option>
                </select>
                <div style="margin-top: 15px;">
                    <button onclick="updateMemberRole()">ë³€ê²½</button>
                    <button class="btn-secondary" onclick="closeRoleModal()">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // ì „ì—­ ë³€ìˆ˜
        // =============================================================================
        var currentYear = 2024;
        var currentMonth = 6;
        var currentMembers = {};
        var editingMember = null;
        var currentReportData = null;
        
        // =============================================================================
        // ì´ˆê¸°í™”
        // =============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            var currentDate = new Date();
            currentYear = currentDate.getFullYear();
            currentMonth = currentDate.getMonth() + 1;
            
            document.getElementById('year').value = currentYear;
            document.getElementById('month').value = currentMonth;
            
            // Enter í‚¤ ì²˜ë¦¬
            document.getElementById('memberName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMember();
                }
            });
            
            // ë…„ë„/ì›” ë³€ê²½ ì‹œ ìë™ ì¡°íšŒ
            document.getElementById('year').addEventListener('change', loadCurrentMonth);
            document.getElementById('month').addEventListener('change', loadCurrentMonth);
            
            loadCurrentMonth();
        });
        
        // =============================================================================
        // ë°ì´í„° ë¡œë“œ ë° ê´€ë¦¬
        // =============================================================================
        function loadCurrentMonth() {
            currentYear = parseInt(document.getElementById('year').value);
            currentMonth = parseInt(document.getElementById('month').value);
            
            loadMemberManagement();
            loadAttendanceTable();
        }
        
        function copyFromPreviousMonth() {
            var messageDiv = document.getElementById('monthMessage');
            
            fetch('/api/copy_previous_month', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ year: currentYear, month: currentMonth })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('ì „ì›” ë©¤ë²„ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!', 'success', messageDiv);
                    loadCurrentMonth();
                } else {
                    showMessage('ì „ì›” ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', messageDiv);
                }
            })
            .catch(error => {
                showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error, 'error', messageDiv);
            });
        }
        
        // =============================================================================
        // ë©¤ë²„ ê´€ë¦¬
        // =============================================================================
        function addMember() {
            var name = document.getElementById('memberName').value.trim();
            var role = document.getElementById('memberRole').value;
            var messageDiv = document.getElementById('memberMessage');
            
            if (!name) {
                showMessage('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error', messageDiv);
                return;
            }
            
            fetch('/api/add_member', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ year: currentYear, month: currentMonth, name: name, role: role })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('ë©¤ë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success', messageDiv);
                    document.getElementById('memberName').value = '';
                    loadCurrentMonth();
                } else {
                    showMessage('ë©¤ë²„ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error', messageDiv);
                }
            })
            .catch(error => {
                showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error, 'error', messageDiv);
            });
        }
        
        function deleteMember(name) {
            if (!confirm("'" + name + "' ë©¤ë²„ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }
            
            fetch('/api/member/' + currentYear + '/' + currentMonth + '/' + encodeURIComponent(name), {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadCurrentMonth();
                } else {
                    alert('ë©¤ë²„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
            });
        }
        
        function openRoleModal(name, currentRole) {
            editingMember = name;
            document.getElementById('roleModalMemberName').textContent = name + 'ì˜ ì—­í•  ë³€ê²½';
            document.getElementById('newRole').value = currentRole;
            document.getElementById('roleModal').style.display = 'block';
        }
        
        function closeRoleModal() {
            document.getElementById('roleModal').style.display = 'none';
            editingMember = null;
        }
        
        function updateMemberRole() {
            if (!editingMember) return;
            
            var newRole = document.getElementById('newRole').value;
            
            fetch('/api/member_role', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ year: currentYear, month: currentMonth, name: editingMember, role: newRole })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeRoleModal();
                    loadCurrentMonth();
                } else {
                    alert('ì—­í•  ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
            });
        }
        
        function loadMemberManagement() {
            var container = document.getElementById('memberManagement');
            container.innerHTML = '<div class="loading">ë©¤ë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
            
            fetch('/api/members/' + currentYear + '/' + currentMonth)
            .then(response => response.json())
            .then(data => {
                currentMembers = data;
                displayMemberManagement(data);
            })
            .catch(error => {
                container.innerHTML = '<div class="error">ë©¤ë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error + '</div>';
            });
        }
        
        function displayMemberManagement(members) {
            var container = document.getElementById('memberManagement');
            
            if (Object.keys(members).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>ë“±ë¡ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤</h3><p>ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì „ì›” ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì„¸ìš”.</p></div>';
                return;
            }
            
            var memberEntries = Object.keys(members);
            memberEntries.sort((a, b) => (members[a].order || 0) - (members[b].order || 0));
            
            var html = '<div class="member-management" id="sortable-members">';
            
            memberEntries.forEach(name => {
                var member = members[name];
                html += `
                    <div class="member-card" data-member-name="${name}">
                        <div class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â‹®â‹®</div>
                        <div class="member-info">
                            <div class="member-name">${name}</div>
                            <div class="member-role">${member.role}</div>
                        </div>
                        <div class="member-actions">
                            <button class="btn-warning" onclick="openRoleModal('${name}', '${member.role}')">ì—­í•  ë³€ê²½</button>
                            <button class="btn-danger" onclick="deleteMember('${name}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            setTimeout(initializeSortable, 100);
        }
        
        function initializeSortable() {
            var memberContainer = document.querySelector('#sortable-members');
            if (!memberContainer || typeof Sortable === 'undefined') return;
            
            if (memberContainer.sortableInstance) {
                memberContainer.sortableInstance.destroy();
            }
            
            memberContainer.sortableInstance = Sortable.create(memberContainer, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: function(evt) {
                    if (evt.oldIndex !== evt.newIndex) {
                        updateMemberOrder(evt.oldIndex, evt.newIndex);
                    }
                }
            });
        }
        
        function updateMemberOrder(oldIndex, newIndex) {
            var memberNames = Object.keys(currentMembers);
            memberNames.sort((a, b) => (currentMembers[a].order || 0) - (currentMembers[b].order || 0));
            
            var movedMember = memberNames.splice(oldIndex, 1)[0];
            memberNames.splice(newIndex, 0, movedMember);
            
            var orders = memberNames.map((name, index) => ({ name: name, order: index }));
            
            fetch('/api/member_orders', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ year: currentYear, month: currentMonth, orders: orders })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadCurrentMonth();
                } else {
                    alert('ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    loadCurrentMonth();
                }
            })
            .catch(error => {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
                loadCurrentMonth();
            });
        }
        
        // =============================================================================
        // ì¶œì„ ê´€ë¦¬
        // =============================================================================
        function loadAttendanceTable() {
            var container = document.getElementById('attendanceTable');
            container.innerHTML = '<div class="loading">ì¶œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
            
            fetch('/api/monthly_report/' + currentYear + '/' + currentMonth)
            .then(response => response.json())
            .then(data => {
                currentReportData = data;
                displayAttendanceTable(data);
            })
            .catch(error => {
                container.innerHTML = '<div class="error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error + '</div>';
            });
        }
        
        function displayAttendanceTable(responseData) {
            var container = document.getElementById('attendanceTable');
            var data = responseData.members || responseData;
            var dates = responseData.dates || [];
            
            if (Object.keys(data).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>ë“±ë¡ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤</h3><p>ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì „ì›” ë°ì´í„°ë¥¼ ë³µì‚¬í•˜ì„¸ìš”.</p></div>';
                return;
            }
            
            var memberEntries = Object.keys(data);
            memberEntries.sort((a, b) => (data[a].order || 0) - (data[b].order || 0));
            
            var finalDates = dates;
            if (finalDates.length === 0 && memberEntries.length > 0) {
                finalDates = Object.keys(data[memberEntries[0]].attendance || {}).sort();
            }
            
            var html = '<div class="table-container"><table class="attendance-table">';
            
            // í—¤ë”
            html += '<thead><tr>';
            html += '<th>ì§ì±…</th><th>ì„±ëª…</th><th>í•©ê³„</th>';
            
            finalDates.forEach(date => {
                var dateObj = new Date(date);
                var weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                var weekday = weekdays[dateObj.getDay()];
                var day = dateObj.getDate();
                html += `<th>${currentMonth}ì›”<br>${day}ì¼<br>${weekday}</th>`;
            });
            
            html += '<th>ê¸°íƒ€1</th><th>ê¸°íƒ€2</th><th>ê¸°íƒ€3</th>';
            html += '</tr></thead>';
            
            // ë°”ë””
            html += '<tbody>';
            memberEntries.forEach(name => {
                var info = data[name];
                if (!info || !info.stats) return;
                
                var stats = info.stats;
                var rowClass = stats.meets_requirement ? 'pass' : 'fail';
                
                html += `<tr class="${rowClass}">`;
                html += `<td><strong>${info.role || 'ë¯¸ì •'}</strong></td>`;
                html += `<td><strong>${name}</strong></td>`;
                html += `<td><strong>${stats.total || 0}</strong></td>`;
                
                // ì •ê·œ ë‚ ì§œë³„ ì¶œì„
                finalDates.forEach(date => {
                    var attendance = info.attendance || {};
                    var status = attendance[date] || 0;
                    var cellClass = status === 1 ? 'present' : 'absent';
                    var displayText = status === 1 ? '1' : '0';
                    
                    html += `<td class="attendance-cell ${cellClass}" onclick="toggleAttendance('${name}', '${date}', this)" title="${name} - ${date}">${displayText}</td>`;
                });
                
                // ê¸°íƒ€ ì¹¼ëŸ¼ - attendanceì—ì„œë§Œ ê°€ì ¸ì˜¤ê¸°
                var attendance = info.attendance || {};
                var extraAttendance = info.extraAttendance || {}; // ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±ì„ ìœ„í•´
                
                // attendance ìš°ì„ , extraAttendanceëŠ” í˜¸í™˜ì„±ì„ ìœ„í•œ fallback
                var extra1 = attendance.extra1 || extraAttendance.extra1 || 0;
                var extra2 = attendance.extra2 || extraAttendance.extra2 || 0;
                var extra3 = attendance.extra3 || extraAttendance.extra3 || 0;
                
                var extra1Class = (extra1 == 1) ? 'present' : 'absent';
                var extra2Class = (extra2 == 1) ? 'present' : 'absent';
                var extra3Class = (extra3 == 1) ? 'present' : 'absent';
                
                html += `<td class="attendance-cell ${extra1Class}" onclick="toggleAttendance('${name}', 'extra1', this)" title="${name} - ê¸°íƒ€1">${extra1}</td>`;
                html += `<td class="attendance-cell ${extra2Class}" onclick="toggleAttendance('${name}', 'extra2', this)" title="${name} - ê¸°íƒ€2">${extra2}</td>`;
                html += `<td class="attendance-cell ${extra3Class}" onclick="toggleAttendance('${name}', 'extra3', this)" title="${name} - ê¸°íƒ€3">${extra3}</td>`;
                
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            // ë²”ë¡€ ì¶”ê°€
            html += `
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                    <h3>ğŸ“‹ ì¶œì„ ì¡°ê±´ ë° ì‚¬ìš©ë²•</h3>
                    <ul style="list-style: none; margin: 10px 0;">
                        <li style="padding: 3px 0;">â–¶ <strong>ìš´ì˜ì§„:</strong> ì¶œì„ ì¡°ê±´ ì—†ìŒ</li>
                        <li style="padding: 3px 0;">â–¶ <strong>í˜ì´ì„œ:</strong> ì›” 3íšŒ ì´ìƒ ì¶œì„</li>
                        <li style="padding: 3px 0;">â–¶ <strong>í˜ì´ì„œ ê°•ë‚¨:</strong> ì›” 3íšŒ ì´ìƒ ì¶œì„ (ê·¸ ì¤‘ ìˆ˜ìš”ì¼ 2íšŒ ì´ìƒ)</li>
                        <li style="padding: 3px 0;">â–¶ <strong>í¬í† :</strong> ì›” 1íšŒ ì´ìƒ ì¶œì„</li>
                        <li style="padding: 3px 0;">â–¶ <strong>ê¸°íƒ€1, ê¸°íƒ€2, ê¸°íƒ€3:</strong> ì¶”ê°€ ì ìˆ˜ (ì´ í•©ê³„ì— í¬í•¨)</li>
                    </ul>
                    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin-top: 10px; border-radius: 0 5px 5px 0;">
                        <p style="margin: 3px 0; color: #1565c0;"><strong>ğŸ’¡ ì‚¬ìš©ë²•:</strong></p>
                        <p style="margin: 3px 0; color: #1565c0;">â€¢ ì¶œì„ ì…€ì„ í´ë¦­í•˜ë©´ ì¶œì„/ë¶ˆì°¸ì´ í† ê¸€ë©ë‹ˆë‹¤</p>
                        <p style="margin: 3px 0; color: #1565c0;">â€¢ ì´ˆë¡ìƒ‰ ë°°ê²½: ì¶œì„ ì¡°ê±´ ì¶©ì¡± âœ…</p>
                        <p style="margin: 3px 0; color: #1565c0;">â€¢ ë¹¨ê°„ìƒ‰ ë°°ê²½: ì¶œì„ ì¡°ê±´ ë¯¸ì¶©ì¡± âŒ</p>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function toggleAttendance(name, date, cell) {
            var currentStatus = cell.classList.contains('present') ? 1 : 0;
            var newStatus = currentStatus === 1 ? 0 : 1;
            
            fetch('/api/attendance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: name,
                    date: date,
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì¦‰ì‹œ ì…€ ìƒíƒœ ì—…ë°ì´íŠ¸
                    cell.classList.remove('present', 'absent');
                    cell.classList.add(newStatus === 1 ? 'present' : 'absent');
                    cell.textContent = newStatus === 1 ? '1' : '0';
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ í…Œì´ë¸” ë‹¤ì‹œ ë¡œë“œ
                    setTimeout(() => loadAttendanceTable(), 100);
                } else {
                    alert('ì¶œì„ ì •ë³´ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
            });
        }
        
        // =============================================================================
        // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        // =============================================================================
        function exportToExcel() {
            if (!currentReportData) {
                showMessage('ë¨¼ì € ì¶œì„ ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”.', 'error', document.getElementById('exportMessage'));
                return;
            }
            
            try {
                var wb = XLSX.utils.book_new();
                var wsData = generateExcelData(currentReportData);
                var ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // ì—´ ë„ˆë¹„ ì„¤ì •
                var colWidths = [
                    { wch: 12 }, // ì§ì±…
                    { wch: 15 }, // ì„±ëª…
                    { wch: 8 },  // í•©ê³„
                ];
                
                var dates = currentReportData.dates || [];
                for (var i = 0; i < dates.length; i++) {
                    colWidths.push({ wch: 10 });
                }
                colWidths.push({ wch: 8 }, { wch: 8 }, { wch: 8 }); // ê¸°íƒ€1,2,3
                
                ws['!cols'] = colWidths;
                XLSX.utils.book_append_sheet(wb, ws, "ì¶œì„í˜„í™©");
                
                var fileName = currentYear + 'ë…„_' + currentMonth + 'ì›”_ì¶œì„í˜„í™©.xlsx';
                XLSX.writeFile(wb, fileName);
                
                showMessage('Excel íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success', document.getElementById('exportMessage'));
            } catch (error) {
                showMessage('Excel íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error', document.getElementById('exportMessage'));
            }
        }
        
        function exportToCSV() {
            if (!currentReportData) {
                showMessage('ë¨¼ì € ì¶œì„ ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”.', 'error', document.getElementById('exportMessage'));
                return;
            }
            
            try {
                var csvContent = generateCSVContent(currentReportData);
                var fileName = currentYear + 'ë…„_' + currentMonth + 'ì›”_ì¶œì„í˜„í™©.csv';
                downloadFile(csvContent, fileName, 'text/csv;charset=utf-8;');
                
                showMessage('CSV íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success', document.getElementById('exportMessage'));
            } catch (error) {
                showMessage('CSV íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error', document.getElementById('exportMessage'));
            }
        }
        
        function generateExcelData(reportData) {
            var data = reportData.members || reportData;
            var dates = reportData.dates || [];
            
            var memberEntries = Object.keys(data);
            memberEntries.sort((a, b) => (data[a].order || 0) - (data[b].order || 0));
            
            var result = [];
            
            // í—¤ë” í–‰
            var header = ['ì§ì±…', 'ì„±ëª…', 'í•©ê³„'];
            dates.forEach(date => {
                var dateObj = new Date(date);
                var month = dateObj.getMonth() + 1;
                var day = dateObj.getDate();
                var weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                var weekday = weekdays[dateObj.getDay()];
                header.push(month + '/' + day + '(' + weekday + ')');
            });
            header.push('ê¸°íƒ€1', 'ê¸°íƒ€2', 'ê¸°íƒ€3');
            result.push(header);
            
            // ë°ì´í„° í–‰
            memberEntries.forEach(name => {
                var info = data[name];
                if (!info || !info.stats) return;
                
                var row = [
                    info.role || 'ë¯¸ì •',
                    name,
                    info.stats.total || 0
                ];
                
                dates.forEach(date => {
                    var attendance = info.attendance || {};
                    var status = attendance[date] || 0;
                    row.push(status === 1 ? 'ì¶œì„' : 'ë¶ˆì°¸');
                });
                
                // attendanceì—ì„œë§Œ ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ì„±ì„ ìœ„í•´ extraAttendance fallback)
                var attendance = info.attendance || {};
                var extraAttendance = info.extraAttendance || {};
                
                var extra1 = attendance.extra1 || extraAttendance.extra1 || 0;
                var extra2 = attendance.extra2 || extraAttendance.extra2 || 0;
                var extra3 = attendance.extra3 || extraAttendance.extra3 || 0;
                
                row.push(extra1, extra2, extra3);
                result.push(row);
            });
            
            return result;
        }
        
        function generateCSVContent(reportData) {
            var excelData = generateExcelData(reportData);
            var csvContent = '';
            
            excelData.forEach(row => {
                var csvRow = row.map(cell => {
                    var cellStr = String(cell);
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        cellStr = '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                }).join(',');
                
                csvContent += csvRow + '\n';
            });
            
            return '\uFEFF' + csvContent; // UTF-8 BOM ì¶”ê°€
        }
        
        function downloadFile(content, fileName, mimeType) {
            var blob = new Blob([content], { type: mimeType });
            var url = window.URL.createObjectURL(blob);
            
            var a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.style.display = 'none';
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            window.URL.revokeObjectURL(url);
        }
        
        // =============================================================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // =============================================================================
        function showMessage(message, type, container) {
            container.innerHTML = '<div class="' + type + '">' + message + '</div>';
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            var modal = document.getElementById('roleModal');
            if (event.target === modal) {
                closeRoleModal();
            }
        };
    </script>
</body>
</html>
