<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <!-- SortableJS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        input, select, button {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }
        
        /* ë·° ì „í™˜ ë²„íŠ¼ - PCì™€ ëª¨ë°”ì¼ ëª¨ë‘ í‘œì‹œ */
        .view-toggle {
            display: block; /* í•­ìƒ í‘œì‹œ */
            text-align: center;
            margin-bottom: 20px;
        }
        
        .view-toggle button {
            margin: 0 5px;
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .view-toggle button.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .view-toggle button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
        }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .attendance-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
            min-width: 60px;
        }
        
        .attendance-table td {
            padding: 10px 6px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            min-width: 60px;
        }
        
        .attendance-cell {
            cursor: pointer;
            user-select: none;
            font-weight: 600;
            transition: all 0.2s ease;
            border-radius: 4px;
            margin: 2px;
            padding: 8px;
            min-width: 40px;
            min-height: 40px;
            text-align: center;
            vertical-align: middle;
        }
        
        .attendance-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .present {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }
        
        .absent {
            background: white;
            color: #333;
            border: 2px solid #dee2e6;
        }
        
        .pass {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .fail {
            background-color: #ffebee;
            color: #c62828;
        }
        
        /* ë©¤ë²„ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
        .member-selector {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .member-selector select {
            min-width: 200px;
            font-size: 16px;
            padding: 12px 16px;
        }
        
        .member-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }
        
        /* ì¹´ë“œ ë·° ë‚´ë¹„ê²Œì´ì…˜ */
        .card-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .nav-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            min-width: 80px;
        }
        
        .nav-button:hover {
            background: #5a67d8;
        }
        
        .nav-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .member-indicator {
            font-weight: bold;
            color: #333;
            text-align: center;
            flex: 1;
            margin: 0 15px;
        }
        
        /* ë‹¨ì¼ ì¹´ë“œ í‘œì‹œ */
        .single-card-container {
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .no-member-selected {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #ddd;
        }
        
        .no-member-selected h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .mobile-view {
            display: none;
        }
        
        .member-card-view {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .member-card-view.fail {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .member-card-view.pass {
            border-left-color: #28a745;
            background: #f8fff8;
        }
        
        .member-header-mobile {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .member-name-mobile {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }
        
        .member-role-mobile {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .member-stats-mobile {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }
        
        .attendance-grid-mobile {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .attendance-item-mobile {
            text-align: center;
            padding: 10px 5px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .attendance-item-mobile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .attendance-item-mobile.present {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border-color: #4caf50;
        }
        
        .attendance-item-mobile.absent {
            background: white;
            color: #333;
            border-color: #dee2e6;
        }
        
        .date-label-mobile {
            font-size: 0.7em;
            line-height: 1.2;
            margin-bottom: 5px;
        }
        
        .attendance-value-mobile {
            font-size: 1.1em;
            font-weight: bold;
        }
        
        /* ë©¤ë²„ ê´€ë¦¬ */
        .member-management {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .member-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 80px;
            cursor: move;
            position: relative;
        }
        
        .member-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-left: 40px;
        }
        
        .member-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            min-width: 100px;
        }
        
        .member-role {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .member-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .member-actions button {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: move;
            color: #6c757d;
            font-size: 18px;
            padding: 5px;
        }
        
        .sortable-ghost {
            opacity: 0.3;
            background: #f8f9fa;
        }
        
        .sortable-drag {
            opacity: 0.6;
            transform: rotate(5deg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        /* PC ë²„ì „ ì¹´ë“œë·° ìµœì í™” */
        @media (min-width: 769px) {
            .desktop-view {
                display: block; /* PCì—ì„œ ê¸°ë³¸ê°’ì€ í…Œì´ë¸” ë·° */
            }
            
            .mobile-view {
                display: none; /* PCì—ì„œ ê¸°ë³¸ê°’ì€ ì¹´ë“œë·° ìˆ¨ê¹€ */
            }
            
            /* PCì—ì„œ ì¹´ë“œë·°ê°€ ì„ íƒëœ ê²½ìš° */
            .mobile-view.active {
                display: block;
            }
            
            .desktop-view.inactive {
                display: none;
            }
            
            /* PC ì¹´ë“œë·° ìŠ¤íƒ€ì¼ ì¡°ì • */
            .member-card-view {
                max-width: 800px;
                margin: 0 auto 20px auto;
            }
            
            .single-card-container {
                min-height: 300px;
            }
            
            /* PC ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í¬ê¸° ì¡°ì • */
            .card-navigation {
                max-width: 600px;
                margin: 0 auto 20px auto;
            }
            
            .nav-button {
                padding: 12px 20px;
                font-size: 16px;
                min-width: 100px;
            }
            
            /* PC ë©¤ë²„ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
            .member-selector {
                max-width: 400px;
                margin: 0 auto 20px auto;
            }
            
            .member-selector select {
                min-width: 250px;
                font-size: 16px;
            }
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 15px;
            }
            
            .section {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .controls > * {
                width: 100%;
            }
            
            input, select, button {
                padding: 12px;
                font-size: 16px;
            }
            
            /* ëª¨ë°”ì¼ì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì¹´ë“œ ë·° */
            .desktop-view {
                display: none;
            }
            
            .mobile-view {
                display: block;
            }
            
            .member-card {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                padding: 15px;
            }
            
            .member-info {
                margin-left: 0;
                flex-direction: column;
                gap: 10px;
                align-items: center;
                text-align: center;
            }
            
            .member-actions {
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .drag-handle {
                position: static;
                transform: none;
                align-self: center;
                margin-bottom: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
            <p>íš¨ìœ¨ì ì¸ ì¶œì„ ê´€ë¦¬ë¥¼ ìœ„í•œ ì›¹ ì‹œìŠ¤í…œ</p>
        </div>
        
        <div class="content">
            <!-- ì›” ì„ íƒ -->
            <div class="section">
                <h2>ğŸ“… ì›” ì„ íƒ ë° ê´€ë¦¬</h2>
                <div class="controls">
                    <label>ë…„ë„:</label>
                    <input type="number" id="year" value="2024" min="2020" max="2030">
                    <label>ì›”:</label>
                    <select id="month">
                        <option value="1">1ì›”</option>
                        <option value="2">2ì›”</option>
                        <option value="3">3ì›”</option>
                        <option value="4">4ì›”</option>
                        <option value="5">5ì›”</option>
                        <option value="6" selected>6ì›”</option>
                        <option value="7">7ì›”</option>
                        <option value="8">8ì›”</option>
                        <option value="9">9ì›”</option>
                        <option value="10">10ì›”</option>
                        <option value="11">11ì›”</option>
                        <option value="12">12ì›”</option>
                    </select>
                    <button onclick="loadCurrentMonth()">ì¡°íšŒ</button>
                    <button class="btn-success" onclick="copyFromPreviousMonth()">ì „ì›” ë©¤ë²„ ë³µì‚¬</button>
                </div>
                <div id="monthMessage"></div>
            </div>
            
            <!-- ë©¤ë²„ ì¶”ê°€ -->
            <div class="section">
                <h2>ğŸ‘¥ ë©¤ë²„ ì¶”ê°€</h2>
                <div class="controls">
                    <input type="text" id="memberName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <select id="memberRole">
                        <option value="ìš´ì˜ì§„">ìš´ì˜ì§„</option>
                        <option value="í˜ì´ì„œ">í˜ì´ì„œ</option>
                        <option value="í˜ì´ì„œ ê°•ë‚¨">í˜ì´ì„œ ê°•ë‚¨</option>
                        <option value="í¬í† ">í¬í† </option>
                    </select>
                    <button onclick="addMember()">ë©¤ë²„ ì¶”ê°€</button>
                </div>
                <div id="memberMessage"></div>
            </div>
            
            <!-- ì¶œì„ í˜„í™© -->
            <div class="section">
                <h2>ğŸ“Š ì¶œì„ í˜„í™©</h2>
                <div id="attendanceTable">
                    <div class="loading">ì¶œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                </div>
            </div>
            
            <!-- ë©¤ë²„ ê´€ë¦¬ -->
            <div class="section">
                <h2>ğŸ‘¤ ë©¤ë²„ ê´€ë¦¬</h2>
                <div id="memberManagement">
                    <div class="loading">ë©¤ë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì—­í•  ë³€ê²½ ëª¨ë‹¬ -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ì—­í•  ë³€ê²½</h3>
                <span class="close" onclick="closeRoleModal()">&times;</span>
            </div>
            <div>
                <p id="roleModalMemberName"></p>
                <select id="newRole">
                    <option value="ìš´ì˜ì§„">ìš´ì˜ì§„</option>
                    <option value="í˜ì´ì„œ">í˜ì´ì„œ</option>
                    <option value="í˜ì´ì„œ ê°•ë‚¨">í˜ì´ì„œ ê°•ë‚¨</option>
                    <option value="í¬í† ">í¬í† </option>
                </select>
                <div style="margin-top: 20px;">
                    <button onclick="updateMemberRole()">ë³€ê²½</button>
                    <button class="btn-secondary" onclick="closeRoleModal()">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        var currentYear = 2024;
        var currentMonth = 6;
        var currentMembers = {};
        var editingMember = null;
        var currentView = 'auto'; // ìë™ ê°ì§€ (ëª¨ë°”ì¼: card, PC: table)
        var selectedMemberIndex = 0; // í˜„ì¬ ì„ íƒëœ ë©¤ë²„ ì¸ë±ìŠ¤
        var memberList = []; // ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ (ì •ë ¬ëœ)
        var userSelectedView = null; // ì‚¬ìš©ìê°€ ì§ì ‘ ì„ íƒí•œ ë·° (nullì´ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
        
        // í˜„ì¬ í™˜ê²½ì´ ëª¨ë°”ì¼ì¸ì§€ í™•ì¸
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // ê¸°ë³¸ ë·° ê²°ì • (ëª¨ë°”ì¼: card, PC: table)
        function getDefaultView() {
            return isMobile() ? 'card' : 'table';
        }
        
        // í˜„ì¬ ì‚¬ìš©í•´ì•¼ í•  ë·° ê²°ì •
        function getCurrentView() {
            // ì‚¬ìš©ìê°€ ì§ì ‘ ì„ íƒí•œ ë·°ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒ ì‚¬ìš©
            if (userSelectedView) {
                return userSelectedView;
            }
            // ì—†ìœ¼ë©´ í™˜ê²½ì— ë§ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
            return getDefaultView();
        }
        document.addEventListener('DOMContentLoaded', function() {
            var currentDate = new Date();
            currentYear = currentDate.getFullYear();
            currentMonth = currentDate.getMonth() + 1;
            
            document.getElementById('year').value = currentYear;
            document.getElementById('month').value = currentMonth;
            
            // Enter í‚¤ ì²˜ë¦¬
            document.getElementById('memberName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addMember();
                }
            });
            
            // ë…„ë„/ì›” ë³€ê²½ ì‹œ ìë™ ì¡°íšŒ
            document.getElementById('year').addEventListener('change', loadCurrentMonth);
            document.getElementById('month').addEventListener('change', loadCurrentMonth);
            
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            loadCurrentMonth();
        });
        
        // í˜„ì¬ ì›” ë°ì´í„° ë¡œë“œ
        function loadCurrentMonth() {
            currentYear = parseInt(document.getElementById('year').value);
            currentMonth = parseInt(document.getElementById('month').value);
            loadMemberManagement();
            loadAttendanceTable();
        }
        
        // ì „ì›” ë©¤ë²„ ë³µì‚¬
        function copyFromPreviousMonth() {
            var messageDiv = document.getElementById('monthMessage');
            
            fetch('/api/copy_previous_month', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    showMessage('ì „ì›” ë©¤ë²„ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!', 'success', messageDiv);
                    // ì „ì›” ë©¤ë²„ ë³µì‚¬ í›„ ì²« ë²ˆì§¸ ë©¤ë²„ ì„ íƒ
                    selectedMemberIndex = 0;
                    loadCurrentMonthWithSync();
                } else {
                    showMessage('ì „ì›” ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error', messageDiv);
                }
            })
            .catch(function(error) {
                showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error, 'error', messageDiv);
            });
        }
        
        // ë©¤ë²„ ì¶”ê°€
        function addMember() {
            var name = document.getElementById('memberName').value.trim();
            var role = document.getElementById('memberRole').value;
            var messageDiv = document.getElementById('memberMessage');
            
            if (!name) {
                showMessage('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error', messageDiv);
                return;
            }
            
            fetch('/api/add_member', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: name,
                    role: role
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    showMessage('ë©¤ë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success', messageDiv);
                    document.getElementById('memberName').value = '';
                    
                    // ë©¤ë²„ ì¶”ê°€ í›„ ì „ì²´ ì—…ë°ì´íŠ¸ (ìˆœì„œ ìœ ì§€)
                    loadCurrentMonthWithSync();
                } else {
                    showMessage('ë©¤ë²„ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error', messageDiv);
                }
            })
            .catch(function(error) {
                showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error, 'error', messageDiv);
            });
        }
        
        // ë©¤ë²„ ì‚­ì œ
        function deleteMember(name) {
            if (!confirm("'" + name + "' ë©¤ë²„ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }
            
            // í˜„ì¬ ì„ íƒëœ ë©¤ë²„ ì €ì¥
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }
            
            fetch('/api/member/' + currentYear + '/' + currentMonth + '/' + encodeURIComponent(name), {
                method: 'DELETE'
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // ì‚­ì œëœ ë©¤ë²„ê°€ í˜„ì¬ ì„ íƒëœ ë©¤ë²„ì¸ ê²½ìš° ì²« ë²ˆì§¸ ë©¤ë²„ë¡œ ë³€ê²½
                    if (currentSelectedMemberName === name) {
                        selectedMemberIndex = 0;
                        loadCurrentMonthWithSync();
                    } else {
                        // ë‹¤ë¥¸ ë©¤ë²„ê°€ ì„ íƒëœ ê²½ìš° ì„ íƒ ìœ ì§€
                        loadCurrentMonthWithSync(currentSelectedMemberName);
                    }
                } else {
                    alert('ë©¤ë²„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(function(error) {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
            });
        }
        
        // ì—­í•  ë³€ê²½ ì™„ë£Œ í›„ ì—…ë°ì´íŠ¸
        function updateMemberRole() {
            if (!editingMember) return;
            
            // í˜„ì¬ ì„ íƒëœ ë©¤ë²„ ì €ì¥
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }
            
            var newRole = document.getElementById('newRole').value;
            
            fetch('/api/member_role', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: editingMember,
                    role: newRole
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    closeRoleModal();
                    // ì—­í•  ë³€ê²½ í›„ ì„ íƒ ìœ ì§€í•˜ë©´ì„œ ì—…ë°ì´íŠ¸
                    loadCurrentMonthWithSync(currentSelectedMemberName);
                } else {
                    alert('ì—­í•  ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(function(error) {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
            });
        }
        
        // ë©¤ë²„ ê´€ë¦¬ì™€ ì¶œì„ í˜„í™©ì„ ë™ê¸°í™”í•˜ì—¬ ë¡œë“œ
        function loadCurrentMonthWithSync(selectedMemberName) {
            // ë©¤ë²„ ê´€ë¦¬ ë¨¼ì € ë¡œë“œ
            loadMemberManagement();
            
            // ì¶œì„ í˜„í™©ì„ ì„ íƒëœ ë©¤ë²„ì™€ í•¨ê»˜ ë¡œë“œ
            if (selectedMemberName) {
                loadAttendanceTableWithMemberSelection(selectedMemberName);
            } else {
                loadAttendanceTable();
            }
        }
        
        // ì—­í•  ë³€ê²½ ëª¨ë‹¬
        function openRoleModal(name, currentRole) {
            editingMember = name;
            document.getElementById('roleModalMemberName').textContent = name + 'ì˜ ì—­í•  ë³€ê²½';
            document.getElementById('newRole').value = currentRole;
            document.getElementById('roleModal').style.display = 'block';
        }
        
        function closeRoleModal() {
            document.getElementById('roleModal').style.display = 'none';
            editingMember = null;
        }
        
        function updateMemberRole() {
            if (!editingMember) return;
            
            var newRole = document.getElementById('newRole').value;
            
            fetch('/api/member_role', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: editingMember,
                    role: newRole
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    closeRoleModal();
                    loadCurrentMonth();
                } else {
                    alert('ì—­í•  ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(function(error) {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
            });
        }
        
        // ë©¤ë²„ ê´€ë¦¬ ë¡œë“œ
        function loadMemberManagement() {
            var container = document.getElementById('memberManagement');
            container.innerHTML = '<div class="loading">ë©¤ë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
            
            fetch('/api/members/' + currentYear + '/' + currentMonth)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                currentMembers = data;
                displayMemberManagement(data);
            })
            .catch(function(error) {
                container.innerHTML = '<div class="error">ë©¤ë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error + '</div>';
            });
        }
        
        // ë©¤ë²„ ê´€ë¦¬ í™”ë©´ í‘œì‹œ
        function displayMemberManagement(members) {
            var container = document.getElementById('memberManagement');
            
            if (Object.keys(members).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>ë“±ë¡ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤</h3><p>ìœ„ì˜ "ë©¤ë²„ ì¶”ê°€" ì„¹ì…˜ì—ì„œ ìƒˆ ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ "ì „ì›” ë©¤ë²„ ë³µì‚¬" ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.</p></div>';
                return;
            }
            
            // ë©¤ë²„ë¥¼ order ìˆœìœ¼ë¡œ ì •ë ¬
            var memberEntries = Object.keys(members);
            memberEntries.sort(function(a, b) {
                var orderA = members[a].order || 0;
                var orderB = members[b].order || 0;
                return orderA - orderB;
            });
            
            var html = '<div class="member-management" id="sortable-members">';
            
            for (var i = 0; i < memberEntries.length; i++) {
                var name = memberEntries[i];
                var member = members[name];
                
                html += '<div class="member-card" data-member-name="' + name + '">';
                html += '<div class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â‹®â‹®</div>';
                html += '<div class="member-info">';
                html += '<div class="member-name">' + name + '</div>';
                html += '<div class="member-role">' + member.role + '</div>';
                html += '</div>';
                html += '<div class="member-actions">';
                html += '<button class="btn-warning" onclick="openRoleModal(\'' + name + '\', \'' + member.role + '\')">ì—­í•  ë³€ê²½</button>';
                html += '<button class="btn-danger" onclick="deleteMember(\'' + name + '\')">ì‚­ì œ</button>';
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>';
            container.innerHTML = html;
            
            // Sortable ì´ˆê¸°í™”
            setTimeout(function() {
                initializeSortable();
            }, 100);
        }
        
        // Sortable ì´ˆê¸°í™”
        function initializeSortable() {
            var memberContainer = document.querySelector('#sortable-members');
            
            if (!memberContainer) return;
            if (typeof Sortable === 'undefined') return;
            
            if (memberContainer.sortableInstance) {
                memberContainer.sortableInstance.destroy();
            }
            
            memberContainer.sortableInstance = Sortable.create(memberContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                handle: '.drag-handle',
                onEnd: function(evt) {
                    if (evt.oldIndex !== evt.newIndex) {
                        updateMemberOrderByDrag(evt.oldIndex, evt.newIndex);
                    }
                }
            });
        }
        
        // ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½
        function updateMemberOrderByDrag(oldIndex, newIndex) {
            var memberNames = Object.keys(currentMembers);
            memberNames.sort(function(a, b) {
                var orderA = currentMembers[a].order || 0;
                var orderB = currentMembers[b].order || 0;
                return orderA - orderB;
            });
            
            // í˜„ì¬ ì„ íƒëœ ë©¤ë²„ ì´ë¦„ ì €ì¥ (ì¹´ë“œë·°ìš©)
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }
            
            // ë°°ì—´ì—ì„œ ìš”ì†Œ ì´ë™
            var movedMember = memberNames.splice(oldIndex, 1)[0];
            memberNames.splice(newIndex, 0, movedMember);
            
            // ìƒˆë¡œìš´ order ê°’ë“¤ ìƒì„±
            var orders = [];
            for (var i = 0; i < memberNames.length; i++) {
                orders.push({
                    name: memberNames[i],
                    order: i
                });
            }
            
            // ì„œë²„ì— ì—…ë°ì´íŠ¸ ìš”ì²­
            fetch('/api/member_orders', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    orders: orders
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // ë©¤ë²„ ê´€ë¦¬ì™€ ì¶œì„ í˜„í™© ëª¨ë‘ ì—…ë°ì´íŠ¸
                    loadMemberManagement();
                    
                    // ì¶œì„ í˜„í™©ë„ ì—…ë°ì´íŠ¸í•˜ë˜, ì¹´ë“œë·°ì—ì„œ ì„ íƒëœ ë©¤ë²„ ìœ ì§€
                    loadAttendanceTableWithMemberSelection(currentSelectedMemberName);
                } else {
                    alert('ìˆœì„œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    loadCurrentMonth();
                }
            })
            .catch(function(error) {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
                loadCurrentMonth();
            });
        }
        
        // ì„ íƒëœ ë©¤ë²„ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì¶œì„ í…Œì´ë¸” ë¡œë“œ
        function loadAttendanceTableWithMemberSelection(selectedMemberName) {
            var container = document.getElementById('attendanceTable');
            container.innerHTML = '<div class="loading">ì¶œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
            
            fetch('/api/monthly_report/' + currentYear + '/' + currentMonth)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                // ìƒˆë¡œìš´ ìˆœì„œë¡œ ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                var memberEntries = Object.keys(data.members || data);
                memberEntries.sort(function(a, b) {
                    var dataObj = data.members || data;
                    var orderA = dataObj[a].order || 0;
                    var orderB = dataObj[b].order || 0;
                    return orderA - orderB;
                });
                
                // ì´ì „ì— ì„ íƒëœ ë©¤ë²„ì˜ ìƒˆë¡œìš´ ì¸ë±ìŠ¤ ì°¾ê¸°
                if (selectedMemberName && memberEntries.indexOf(selectedMemberName) !== -1) {
                    selectedMemberIndex = memberEntries.indexOf(selectedMemberName);
                } else {
                    // ì´ì „ ì„ íƒì´ ì—†ê±°ë‚˜ í•´ë‹¹ ë©¤ë²„ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë©¤ë²„ ì„ íƒ
                    selectedMemberIndex = 0;
                }
                
                displayAttendanceTable(data, currentYear, currentMonth);
            })
            .catch(function(error) {
                container.innerHTML = '<div class="error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error + '</div>';
            });
        }
        
        // ì¶œì„ í…Œì´ë¸” ë¡œë“œ
        function loadAttendanceTable() {
            var container = document.getElementById('attendanceTable');
            container.innerHTML = '<div class="loading">ì¶œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
            
            fetch('/api/monthly_report/' + currentYear + '/' + currentMonth)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                displayAttendanceTable(data, currentYear, currentMonth);
            })
            .catch(function(error) {
                container.innerHTML = '<div class="error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error + '</div>';
            });
        }
        
        // ì¶œì„ í…Œì´ë¸” í‘œì‹œ
        function displayAttendanceTable(responseData, year, month) {
            var container = document.getElementById('attendanceTable');
            var data = responseData.members || responseData;
            var dates = responseData.dates || [];
            
            if (Object.keys(data).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>ë“±ë¡ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤</h3><p>ìœ„ì˜ "ë©¤ë²„ ì¶”ê°€" ì„¹ì…˜ì—ì„œ ìƒˆ ë©¤ë²„ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ "ì „ì›” ë©¤ë²„ ë³µì‚¬" ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.</p></div>';
                return;
            }
            
            // ë©¤ë²„ë¥¼ order ìˆœìœ¼ë¡œ ì •ë ¬
            var memberEntries = Object.keys(data);
            memberEntries.sort(function(a, b) {
                var orderA = data[a].order || 0;
                var orderB = data[b].order || 0;
                return orderA - orderB;
            });
            
            // ë‚ ì§œê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ë©¤ë²„ì˜ ì¶œì„ ë°ì´í„°ì—ì„œ ì¶”ì¶œ
            var finalDates = dates;
            if (finalDates.length === 0 && memberEntries.length > 0) {
                finalDates = Object.keys(data[memberEntries[0]].attendance || {}).sort();
            }
            
            var html = '';
            
            // í˜„ì¬ ì‚¬ìš©í•  ë·° ê²°ì •
            var viewToUse = getCurrentView();
            
            // ë·° í† ê¸€ ë²„íŠ¼ (PCì™€ ëª¨ë°”ì¼ ëª¨ë‘ í‘œì‹œ)
            html += '<div class="view-toggle">';
            
            if (viewToUse === 'table') {
                html += '<button id="tableViewBtn" class="active" onclick="switchToTableView()">ğŸ“Š í…Œì´ë¸” ë·°</button>';
                html += '<button id="cardViewBtn" onclick="switchToCardView()">ğŸ“‹ ì¹´ë“œ ë·°</button>';
            } else {
                html += '<button id="tableViewBtn" onclick="switchToTableView()">ğŸ“Š í…Œì´ë¸” ë·°</button>';
                html += '<button id="cardViewBtn" class="active" onclick="switchToCardView()">ğŸ“‹ ì¹´ë“œ ë·°</button>';
            }
            
            html += '</div>';
            
            // ë°ìŠ¤í¬í†± í…Œì´ë¸” ë·°
            html += '<div class="desktop-view"' + (viewToUse === 'table' ? '' : ' style="display: none;"') + '>';
            html += generateTableView(data, memberEntries, finalDates, year, month);
            html += '</div>';
            
            // ëª¨ë°”ì¼ ì¹´ë“œ ë·°
            html += '<div class="mobile-view"' + (viewToUse === 'card' ? '' : ' style="display: none;"') + '>';
            html += generateCardView(data, memberEntries, finalDates, year, month);
            html += '</div>';
            
            // ë²”ë¡€ ì¶”ê°€
            html += '<div style="margin-top: 30px; padding: 25px; background: #f8f9fa; border-radius: 10px;">';
            html += '<h3>ğŸ“‹ ì¶œì„ ì¡°ê±´ ë° ì‚¬ìš©ë²•</h3>';
            html += '<ul style="list-style: none; margin: 15px 0;">';
            html += '<li style="padding: 5px 0;">â–¶ <strong>ìš´ì˜ì§„:</strong> ì¶œì„ ì¡°ê±´ ì—†ìŒ</li>';
            html += '<li style="padding: 5px 0;">â–¶ <strong>í˜ì´ì„œ:</strong> ì›” 3íšŒ ì´ìƒ ì¶œì„</li>';
            html += '<li style="padding: 5px 0;">â–¶ <strong>í˜ì´ì„œ ê°•ë‚¨:</strong> ì›” 3íšŒ ì´ìƒ ì¶œì„ (ê·¸ ì¤‘ ìˆ˜ìš”ì¼ 2íšŒ ì´ìƒ)</li>';
            html += '<li style="padding: 5px 0;">â–¶ <strong>í¬í† :</strong> ì›” 1íšŒ ì´ìƒ ì¶œì„</li>';
            html += '</ul>';
            html += '<div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin-top: 15px; border-radius: 0 8px 8px 0;">';
            html += '<p style="margin: 5px 0; color: #1565c0;"><strong>ğŸ’¡ ì‚¬ìš©ë²•:</strong></p>';
            html += '<p style="margin: 5px 0; color: #1565c0;">â€¢ ì¶œì„ ì…€ì„ í´ë¦­í•˜ë©´ ì¶œì„/ë¶ˆì°¸ì´ í† ê¸€ë©ë‹ˆë‹¤</p>';
            html += '<p style="margin: 5px 0; color: #1565c0;">â€¢ ì´ˆë¡ìƒ‰ ë°°ê²½: ì¶œì„ ì¡°ê±´ ì¶©ì¡± âœ…</p>';
            html += '<p style="margin: 5px 0; color: #1565c0;">â€¢ ë¹¨ê°„ìƒ‰ ë°°ê²½: ì¶œì„ ì¡°ê±´ ë¯¸ì¶©ì¡± âŒ</p>';
            if (isMobile()) {
                html += '<p style="margin: 5px 0; color: #1565c0;">â€¢ ğŸ“± ëª¨ë°”ì¼: ê¸°ë³¸ ì¹´ë“œ ë·°, ë©¤ë²„ë³„ ê°œë³„ í™•ì¸</p>';
            } else {
                html += '<p style="margin: 5px 0; color: #1565c0;">â€¢ ğŸ–¥ï¸ PC: ê¸°ë³¸ í…Œì´ë¸” ë·°, ì „ì²´ í•œëˆˆì— í™•ì¸</p>';
            }
            html += '</div>';
            html += '</div>';
            
            container.innerHTML = html;
            
            // í˜„ì¬ ë·° ìƒíƒœ ì„¤ì •
            currentView = viewToUse;
        }
        
        // í…Œì´ë¸” ë·° ìƒì„±
        function generateTableView(data, memberEntries, finalDates, year, month) {
            var isMobile = window.innerWidth <= 768;
            var html = '';
            
            if (isMobile && finalDates.length > 4) {
                html += '<div style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px;">ğŸ“± í‘œë¥¼ ì¢Œìš°ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ëª¨ë“  ë‚ ì§œë¥¼ í™•ì¸í•˜ì„¸ìš”</div>';
            }
            
            html += '<div class="table-container">';
            html += '<table class="attendance-table">';
            
            // í—¤ë”
            html += '<thead><tr>';
            html += '<th style="min-width: 60px;">ì§ì±…</th>';
            html += '<th style="min-width: 80px;">ì„±ëª…</th>';
            html += '<th style="min-width: 50px;">í•©ê³„</th>';
            
            for (var i = 0; i < finalDates.length; i++) {
                var date = finalDates[i];
                var dateObj = new Date(date);
                var weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                var weekday = weekdays[dateObj.getDay()];
                var day = dateObj.getDate();
                html += '<th style="min-width: 50px;">' + month + 'ì›”<br>' + day + 'ì¼<br>' + weekday + '</th>';
            }
            html += '</tr></thead>';
            
            // ë°”ë””
            html += '<tbody>';
            for (var memberIndex = 0; memberIndex < memberEntries.length; memberIndex++) {
                var name = memberEntries[memberIndex];
                var info = data[name];
                
                if (!info || !info.stats) continue;
                
                var stats = info.stats;
                var rowClass = stats.meets_requirement ? 'pass' : 'fail';
                
                html += '<tr class="' + rowClass + '">';
                html += '<td><strong>' + (info.role || 'ë¯¸ì •') + '</strong></td>';
                html += '<td><strong>' + name + '</strong></td>';
                html += '<td><strong>' + (stats.total || 0) + '</strong></td>';
                
                for (var dateIndex = 0; dateIndex < finalDates.length; dateIndex++) {
                    var date = finalDates[dateIndex];
                    var attendance = info.attendance || {};
                    var status = attendance[date] || 0;
                    var cellClass = status === 1 ? 'present' : 'absent';
                    var displayText = status === 1 ? '1' : '0';
                    
                    html += '<td class="attendance-cell ' + cellClass + '" onclick="toggleAttendance(\'' + name + '\', \'' + date + '\', this)" title="' + name + ' - ' + date + ' í´ë¦­í•˜ì—¬ ë³€ê²½">';
                    html += displayText;
                    html += '</td>';
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            
            return html;
        }
        
        // ì¹´ë“œ ë·° ìƒì„± - ì„ íƒëœ ë©¤ë²„ë§Œ í‘œì‹œ
        function generateCardView(data, memberEntries, finalDates, year, month) {
            memberList = memberEntries; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            
            var html = '';
            
            // ë©¤ë²„ ì„ íƒ ë“œë¡­ë‹¤ìš´
            html += '<div class="member-selector">';
            html += '<label>ğŸ‘¤ ë©¤ë²„ ì„ íƒ:</label>';
            html += '<select id="memberSelect" onchange="changeMember()">';
            for (var i = 0; i < memberEntries.length; i++) {
                var name = memberEntries[i];
                var selected = i === selectedMemberIndex ? ' selected' : '';
                html += '<option value="' + i + '"' + selected + '>' + name + '</option>';
            }
            html += '</select>';
            html += '</div>';
            
            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
            html += '<div class="card-navigation">';
            html += '<button class="nav-button" onclick="previousMember()" ' + (selectedMemberIndex <= 0 ? 'disabled' : '') + '>â† ì´ì „</button>';
            html += '<div class="member-indicator">' + (selectedMemberIndex + 1) + ' / ' + memberEntries.length + '</div>';
            html += '<button class="nav-button" onclick="nextMember()" ' + (selectedMemberIndex >= memberEntries.length - 1 ? 'disabled' : '') + '>ë‹¤ìŒ â†’</button>';
            html += '</div>';
            
            // ì„ íƒëœ ë©¤ë²„ ì¹´ë“œ í‘œì‹œ
            html += '<div class="single-card-container">';
            
            if (memberEntries.length === 0) {
                html += '<div class="no-member-selected">';
                html += '<h3>ë“±ë¡ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤</h3>';
                html += '<p>ë©¤ë²„ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
                html += '</div>';
            } else if (selectedMemberIndex >= 0 && selectedMemberIndex < memberEntries.length) {
                var name = memberEntries[selectedMemberIndex];
                var info = data[name];
                
                if (info && info.stats) {
                    var stats = info.stats;
                    var cardClass = stats.meets_requirement ? 'pass' : 'fail';
                    
                    html += '<div class="member-card-view ' + cardClass + '" style="width: 100%; max-width: 600px;">';
                    
                    // ë©¤ë²„ í—¤ë”
                    html += '<div class="member-header-mobile">';
                    html += '<div class="member-name-mobile">' + name + '</div>';
                    html += '<div class="member-role-mobile">' + (info.role || 'ë¯¸ì •') + '</div>';
                    html += '</div>';
                    
                    // í†µê³„
                    html += '<div class="member-stats-mobile">';
                    html += '<div class="stat-item">';
                    html += '<div class="stat-label">ì´ ì¶œì„</div>';
                    html += '<div class="stat-value">' + (stats.total || 0) + 'íšŒ</div>';
                    html += '</div>';
                    html += '<div class="stat-item">';
                    html += '<div class="stat-label">ìˆ˜ìš”ì¼ ì¶œì„</div>';
                    html += '<div class="stat-value">' + (stats.wednesday || 0) + 'íšŒ</div>';
                    html += '</div>';
                    html += '<div class="stat-item">';
                    html += '<div class="stat-label">ì¡°ê±´ ì¶©ì¡±</div>';
                    html += '<div class="stat-value">' + (stats.meets_requirement ? 'âœ…' : 'âŒ') + '</div>';
                    html += '</div>';
                    html += '</div>';
                    
                    // ì¶œì„ ê·¸ë¦¬ë“œ
                    html += '<div class="attendance-grid-mobile">';
                    for (var dateIndex = 0; dateIndex < finalDates.length; dateIndex++) {
                        var date = finalDates[dateIndex];
                        var dateObj = new Date(date);
                        var weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                        var weekday = weekdays[dateObj.getDay()];
                        var day = dateObj.getDate();
                        
                        var attendance = info.attendance || {};
                        var status = attendance[date] || 0;
                        var itemClass = status === 1 ? 'present' : 'absent';
                        var displayText = status === 1 ? 'ì¶œì„' : 'ë¶ˆì°¸';
                        
                        html += '<div class="attendance-item-mobile ' + itemClass + '" onclick="toggleAttendance(\'' + name + '\', \'' + date + '\', this)" title="' + name + ' - ' + date + ' í´ë¦­í•˜ì—¬ ë³€ê²½">';
                        html += '<div class="date-label-mobile">' + month + '/' + day + '<br>' + weekday + '</div>';
                        html += '<div class="attendance-value-mobile">' + displayText + '</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    
                    html += '</div>';
                }
            }
            
            html += '</div>';
            
            return html;
        }
        
        // ë©¤ë²„ ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
        function previousMember() {
            if (selectedMemberIndex > 0) {
                selectedMemberIndex--;
                updateCardViewOnly(); // ì¹´ë“œë·°ë§Œ ì—…ë°ì´íŠ¸, ë·° ë³€ê²½ ì•ˆí•¨
            }
        }
        
        function nextMember() {
            if (selectedMemberIndex < memberList.length - 1) {
                selectedMemberIndex++;
                updateCardViewOnly(); // ì¹´ë“œë·°ë§Œ ì—…ë°ì´íŠ¸, ë·° ë³€ê²½ ì•ˆí•¨
            }
        }
        
        function changeMember() {
            var select = document.getElementById('memberSelect');
            if (select) {
                selectedMemberIndex = parseInt(select.value);
                updateCardViewOnly(); // ì¹´ë“œë·°ë§Œ ì—…ë°ì´íŠ¸, ë·° ë³€ê²½ ì•ˆí•¨
            }
        }
        
        // ì¹´ë“œ ë·°ë§Œ ì—…ë°ì´íŠ¸ (ë·° ë³€ê²½ ì—†ì´)
        function updateCardViewOnly() {
            // í˜„ì¬ ì„ íƒëœ ë©¤ë²„ ì´ë¦„ ì €ì¥
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }
            
            // ì¹´ë“œë·° ë¶€ë¶„ë§Œ ì—…ë°ì´íŠ¸
            var mobileView = document.querySelector('.mobile-view');
            if (mobileView && currentView === 'card') {
                // í˜„ì¬ ë°ì´í„°ë¡œ ì¹´ë“œë·° ë‚´ìš©ë§Œ ë‹¤ì‹œ ìƒì„±
                fetch('/api/monthly_report/' + currentYear + '/' + currentMonth)
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    var memberEntries = Object.keys(data.members || data);
                    memberEntries.sort(function(a, b) {
                        var dataObj = data.members || data;
                        var orderA = dataObj[a].order || 0;
                        var orderB = dataObj[b].order || 0;
                        return orderA - orderB;
                    });
                    
                    var finalDates = data.dates || [];
                    if (finalDates.length === 0 && memberEntries.length > 0) {
                        finalDates = Object.keys((data.members || data)[memberEntries[0]].attendance || {}).sort();
                    }
                    
                    var cardViewHTML = generateCardView(data.members || data, memberEntries, finalDates, currentYear, currentMonth);
                    mobileView.innerHTML = cardViewHTML;
                })
                .catch(function(error) {
                    console.error('ì¹´ë“œë·° ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                });
            }
        }
        
        // ì¹´ë“œ ë·°ë§Œ ì—…ë°ì´íŠ¸ (ì „ì²´ í…Œì´ë¸” ë‹¤ì‹œ ë¡œë“œí•˜ì§€ ì•ŠìŒ)
        function updateCardView() {
            // í˜„ì¬ ì„ íƒëœ ë©¤ë²„ ì´ë¦„ ì €ì¥
            var currentSelectedMemberName = null;
            if (memberList.length > 0 && selectedMemberIndex >= 0 && selectedMemberIndex < memberList.length) {
                currentSelectedMemberName = memberList[selectedMemberIndex];
            }
            
            // ì„ íƒëœ ë©¤ë²„ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì¶œì„ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            loadAttendanceTableWithMemberSelection(currentSelectedMemberName);
        }
        
        // ë·° ì „í™˜ í•¨ìˆ˜ë“¤
        function switchToCardView() {
            var desktopView = document.querySelector('.desktop-view');
            var mobileView = document.querySelector('.mobile-view');
            var cardBtn = document.getElementById('cardViewBtn');
            var tableBtn = document.getElementById('tableViewBtn');
            
            if (desktopView) {
                desktopView.style.display = 'none';
                desktopView.classList.add('inactive');
            }
            if (mobileView) {
                mobileView.style.display = 'block';
                mobileView.classList.add('active');
            }
            if (cardBtn) cardBtn.classList.add('active');
            if (tableBtn) tableBtn.classList.remove('active');
            
            currentView = 'card';
            userSelectedView = 'card'; // ì‚¬ìš©ìê°€ ì§ì ‘ ì„ íƒí–ˆìŒì„ ê¸°ë¡
            
            // ì¹´ë“œ ë·°ë¡œ ì „í™˜ ì‹œ ì²« ë²ˆì§¸ ë©¤ë²„ ì„ íƒ (ì¸ë±ìŠ¤ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ëŠ” ê²½ìš°ë§Œ)
            if (selectedMemberIndex < 0 || selectedMemberIndex >= memberList.length) {
                selectedMemberIndex = 0;
            }
        }
        
        function switchToTableView() {
            var desktopView = document.querySelector('.desktop-view');
            var mobileView = document.querySelector('.mobile-view');
            var cardBtn = document.getElementById('cardViewBtn');
            var tableBtn = document.getElementById('tableViewBtn');
            
            if (desktopView) {
                desktopView.style.display = 'block';
                desktopView.classList.remove('inactive');
            }
            if (mobileView) {
                mobileView.style.display = 'none';
                mobileView.classList.remove('active');
            }
            if (tableBtn) tableBtn.classList.add('active');
            if (cardBtn) cardBtn.classList.remove('active');
            
            currentView = 'table';
            userSelectedView = 'table'; // ì‚¬ìš©ìê°€ ì§ì ‘ ì„ íƒí–ˆìŒì„ ê¸°ë¡
        }
        
        // ì¶œì„ í† ê¸€
        function toggleAttendance(name, date, cell) {
            var currentStatus = cell.classList.contains('present') ? 1 : 0;
            var newStatus = currentStatus === 1 ? 0 : 1;
            
            fetch('/api/attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    year: currentYear,
                    month: currentMonth,
                    name: name,
                    date: date,
                    status: newStatus
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    // ì¦‰ì‹œ ì…€ ìƒíƒœ ì—…ë°ì´íŠ¸
                    cell.classList.remove('present', 'absent');
                    cell.classList.add(newStatus === 1 ? 'present' : 'absent');
                    
                    // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    var valueElement = cell.querySelector('.attendance-value-mobile');
                    if (valueElement) {
                        valueElement.textContent = newStatus === 1 ? 'ì¶œì„' : 'ë¶ˆì°¸';
                    } else {
                        cell.textContent = newStatus === 1 ? '1' : '0';
                    }
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ í…Œì´ë¸” ë‹¤ì‹œ ë¡œë“œ
                    setTimeout(function() {
                        loadAttendanceTable();
                    }, 100);
                } else {
                    alert('ì¶œì„ ì •ë³´ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(function(error) {
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
            });
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(message, type, container) {
            container.innerHTML = '<div class="' + type + '">' + message + '</div>';
            setTimeout(function() {
                container.innerHTML = '';
            }, 5000);
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            var modal = document.getElementById('roleModal');
            if (event.target === modal) {
                closeRoleModal();
            }
        };
    </script>
</body>
</html>